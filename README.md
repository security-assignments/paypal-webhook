# paypal-webook

Set env vars:

* `FROM_EMAIL` -- the from-address for the email. This needs to be either the same as or an alias of the account being impersonated.
* `SUPPORT_EMAIL` -- email address for customers to use for support requests
* `GOOGLE_GROUP_ID` -- id number for the google group
* `GOOGLE_GROUP_NAME` -- name (email address) identifying the google group
* `SANDBOX_GOOGLE_GROUP_ID` -- id number for the sandboxgoogle group
* `SANDBOX_GOOGLE_GROUP_NAME` -- name (email address) identifying the sandbox google group
* `PAYPAL_WEBHOOK_ID_SANDBOX`
* `PAYPAL_WEBHOOK_ID_LIVE`
* `GSUITE_ADMIN_USER` -- the Google Workspace user to impersonate. Emails will be sent from this account, or from an alias of this account.

The service account running the cloud run function needs to have Workspace domain-wide delegation rights.


If paypal mock transactions are being used and paypal validation should be
skipped, set `PAYPAL_MOCK` env var.


## Create paypal webhooks

Using <https://developer.paypal.com>, create a sandbox and live app, and within each,
create a webhook that sends events for PAYMENT.CAPTURE.COMPLETED. Set the webhook ids
as env vars (see above). These ids are needed to verify the webhook event signature.

Set this function's http target as the webhook url. (Chicken and egg, I know!)

Mock transactions sent via the developer portal will not have `custom_id` and
`invoice_id`, although webhooks triggered by transactions generated by
security-assignments.com/store _will_ have these fields.


## Create the target google group

1. On <https://admin.google.com>, set it so that members external to the
organization can be members of the group.
1. Fetch the google group's new id. Use <https://developers.google.com/admin-sdk/directory/reference/rest/v1/groups/list?apix_params=%7B%22customer%22%3A%22my_customer%22%7D> to find it.



## Give the service account access to the google group

Add the service account's email address as an "owner" member of the google group.
This should give the service account permissions to manage group membership.

**Alternatively**, grant GROUP ADMIN role to the service account as follows:

The service account that runs the cloud function needs permissions to manage google
groups for the domain.

Follow this guide: <https://cloud.google.com/identity/docs/how-to/setup#auth-no-dwd>

* The service account "unique id" is the OAuth2 id in the table:
* Use the API Explorer to fetch a list of all roles. Scroll through to find the
  GROUP ADMIN role, and use its id.


## Development

Note that _certain_ (not all) **@example.com** emails will fail if they are
attempted to be added to a google group. I don't know why and I can't discern a
pattern. But adding a legitimate email address hasn't failed on me yet.


### Run locally

```bash
functions_framework --target=main --debug
```

The following:

* Runs with service account credentials
* Skips the paypal signature verification (that it originated from paypal)
* Skips the purchase signature verification (that the paypal order was created by the paypal-order-create function)


```bash
SKIP_CUSTOM_SIG_VERIFIED=1 GOOGLE_APPLICATION_CREDENTIALS=security-assignments-kali-962c34ad5d71.json LOCAL_DEV=1 PAYPAL_MOCK=1 functions-framework --target=do_webhook --debug --source=main.py --port 8082
```

Send a local request using an example webhook body, copied from the [paypal webhook event logs](https://developer.paypal.com/dashboard/webhooks/sandbox): 

```sh
curl --data "@example-webhook-body.json" http://localhost:8082 --header "Content-Type: application/json"
```


### Verify the paypal webhook

`verify.py` is a test script for verifying the paypal web hook using the [`verify-webhook-signature` paypal API endpoint](https://developer.paypal.com/docs/api/webhooks/v1/#verify-webhook-signature_post).


## Deploy

```bash
gcloud functions deploy security-assignments-purchase \
  --entry-point do_webhook \
  --allow-unauthenticated \
  --runtime python39 \
  --env-vars-file env.yml \
  --trigger-http \
  --region us-central1 \
  --security-level secure-always \
  --set-secrets 'PAYPAL_LIVE_CLIENT_SECRET=PAYPAL_LIVE_CLIENT_SECRET:latest,PAYPAL_SANDBOX_CLIENT_SECRET=PAYPAL_SANDBOX_CLIENT_SECRET:latest,PAYPAL_SHARED_SECRET=PAYPAL_SHARED_SECRET:latest' \
  --service-account security-assignments-kali@appspot.gserviceaccount.com
```

View trigger-http url (and more info):

```bash
gcloud functions describe security-assignments-purchase
```


# Sandbox

```sh
gcloud functions deploy security-assignments-purchase-sandbox \
  --entry-point do_webhook \
  --allow-unauthenticated \
  --runtime python39 \
  --env-vars-file env.yml \
  --trigger-http \
  --region us-central1 \
  --security-level secure-always \
  --set-secrets 'PAYPAL_LIVE_CLIENT_SECRET=PAYPAL_LIVE_CLIENT_SECRET:latest,PAYPAL_SANDBOX_CLIENT_SECRET=PAYPAL_SANDBOX_CLIENT_SECRET:latest,PAYPAL_SHARED_SECRET=PAYPAL_SHARED_SECRET:latest' \
  --service-account security-assignments-kali@appspot.gserviceaccount.com

```